<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stress Relief Login</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .message {
      margin-top: 10px;
      font-size: 14px;
      text-align: center;
      padding: 8px;
      border-radius: 8px;
      display: none;
    }

    .error {
      color: #ff4d4d;
      background: rgba(255, 0, 0, 0.1);
    }

    .success {
      color: #00ff99;
      background: rgba(0, 255, 153, 0.1);
    }

    /* Modal styling */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fff;
      padding: 30px;
      border-radius: 10px;
      width: 320px;
      text-align: center;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .modal-content input {
      width: 80%;
      padding: 8px;
      margin-top: 10px;
    }

    .modal-content button {
      padding: 8px 15px;
      margin-top: 15px;
      cursor: pointer;
    }

    .close {
      position: absolute;
      right: 10px;
      top: 5px;
      font-size: 22px;
      cursor: pointer;
      color: #555;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="form-box">
      <h2 id="form-title">Login</h2>

      <!-- Login Form -->
      <form id="login-form">
        <input type="email" name="email" placeholder="Email" required />
        <input type="password" name="password" placeholder="Password" required />
        <button type="submit">Login</button>
        <div id="login-message" class="message"></div>
        <p>Don't have an account? <a href="#" id="show-signup">Sign up</a></p>
        <p><a href="#" id="show-change-password">Change Password</a></p>
      </form>

      <!-- Signup Form -->
      <form id="signup-form" style="display:none;">
        <input type="email" name="email" placeholder="Email" required />
        <input type="password" name="password" placeholder="Password" required />
        <button type="submit">Sign Up</button>
        <div id="signup-message" class="message"></div>
        <p>Already have an account? <a href="#" id="show-login">Login</a></p>
      </form>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="change-password-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Change Password</h2>
      <form id="change-password-form">
        <input type="email" name="email" placeholder="Email" required />
        <input type="password" name="newPassword" placeholder="New Password" required />
        <button type="submit">Update Password</button>
        <div id="change-password-message" class="message"></div>
      </form>
    </div>
  </div>

  <script>
    // âœ… Hide all messages on page show (handles back button)
    window.addEventListener('pageshow', () => {
      document.querySelectorAll('.message').forEach(m => m.style.display = 'none');
    });

    // ---------- FORM TOGGLING ----------
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const formTitle = document.getElementById('form-title');
    const showSignup = document.getElementById('show-signup');
    const showLogin = document.getElementById('show-login');

    showSignup.addEventListener('click', (e) => {
      e.preventDefault();
      loginForm.style.display = 'none';
      signupForm.style.display = 'block';
      formTitle.textContent = 'Sign Up';
    });

    showLogin.addEventListener('click', (e) => {
      e.preventDefault();
      signupForm.style.display = 'none';
      loginForm.style.display = 'block';
      formTitle.textContent = 'Login';
    });

    // ---------- CHANGE PASSWORD MODAL ----------
    const modal = document.getElementById('change-password-modal');
    const showChangePassword = document.getElementById('show-change-password');
    const closeBtn = document.querySelector('.close');

    showChangePassword.addEventListener('click', (e) => {
      e.preventDefault();
      modal.style.display = 'flex';
    });

    closeBtn.addEventListener('click', () => (modal.style.display = 'none'));
    window.addEventListener('click', (e) => {
      if (e.target === modal) modal.style.display = 'none';
    });

    // ---------- MESSAGE HANDLER ----------
    function showMessage(element, text, type) {
      element.textContent = text;
      element.className = `message ${type}`;
      element.style.display = 'block';
    }

    // ---------- LOGIN ----------
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = document.getElementById('login-message');
      msg.style.display = 'none';

      const data = Object.fromEntries(new FormData(loginForm).entries());
      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
          credentials: 'include'
        });
        const result = await res.json();

        if (res.ok) {
          showMessage(msg, result.message || 'Login successful!', 'success');
          setTimeout(() => (window.location.href = '/dashboard.html'), 1200);
        } else {
          showMessage(msg, result.message || 'Invalid credentials!', 'error');
        }
      } catch {
        showMessage(msg, 'Network error. Try again later.', 'error');
      }
    });

    // ---------- SIGNUP ----------
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = document.getElementById('signup-message');
      msg.style.display = 'none';

      const data = Object.fromEntries(new FormData(signupForm).entries());
      try {
        const res = await fetch('/api/auth/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
          credentials: 'include'
        });
        const result = await res.json();

        if (res.ok) {
          showMessage(msg, result.message || 'Signup successful! You can now log in.', 'success');
          setTimeout(() => {
            signupForm.style.display = 'none';
            loginForm.style.display = 'block';
            formTitle.textContent = 'Login';
          }, 1500);
        } else {
          showMessage(msg, result.message || 'User already exists.', 'error');
        }
      } catch {
        showMessage(msg, 'Network error. Try again later.', 'error');
      }
    });

    // ---------- CHANGE PASSWORD ----------
    const changePasswordForm = document.getElementById('change-password-form');
    changePasswordForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = document.getElementById('change-password-message');
      msg.style.display = 'none';

      const data = Object.fromEntries(new FormData(changePasswordForm).entries());
      try {
        const res = await fetch('/api/auth/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
          credentials: 'include'
        });

        const result = await res.json();

        if (res.ok && result.success) {
          showMessage(msg, result.message || 'Password updated successfully!', 'success');
          setTimeout(() => (modal.style.display = 'none'), 1500);
        } else if (result.message && result.message.toLowerCase().includes('not found')) {
          showMessage(msg, 'Email does not exist.', 'error');
        } else {
          showMessage(msg, result.message || 'Error updating password.', 'error');
        }
      } catch (err) {
        console.error(err);
        showMessage(msg, 'Network error. Try again later.', 'error');
      }
    });
  </script>
</body>

</html>